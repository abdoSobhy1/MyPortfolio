name: Supabase Keep Alive (Extended)

on:
  schedule:
    - cron: "* * * * *" # every 3 days
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Keep Supabase awake
        run: |
          echo "Running Supabase keep-alive with insert + select + delete..."
          RANDOM_NAME=$(openssl rand -hex 6)

          # 1️⃣ Insert
          INSERT=$(curl -s -X POST \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"name\": \"${RANDOM_NAME}\"}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/keep_alive")
          echo "Inserted: $INSERT"

          # 2️⃣ Select
          SELECT=$(curl -s -X GET \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/keep_alive?select=*")
          echo "Selected: $SELECT"

          # 3️⃣ Delete
          DELETE=$(curl -s -X DELETE \
            -H "apikey: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            "${{ secrets.SUPABASE_URL }}/rest/v1/keep_alive?name=eq.${RANDOM_NAME}")
          echo "Deleted: $DELETE"
